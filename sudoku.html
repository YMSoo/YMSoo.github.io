<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudoku Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #000000;
        }

        /* Main layout container for two columns on desktop */
        .main-game-layout {
            width: 95vw;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            padding: 1rem;
            align-items: center;
        }
        
        /* Grid and Cell Styling */
        .game-panel {
            width: 100%;
            max-width: 500px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 0;
            border: 2px solid #2d3748;
            width: 100%;
            max-width: 450px;
        }

        .cell {
            width: 100%;
            aspect-ratio: 1 / 1;
            position: relative;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(0.8rem, 4vw, 1.5rem);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.15s ease, transform 0.1s ease;
            box-sizing: border-box;
        }
        
        .cell.initial {
            font-weight: 700;
            color: rgb(25, 40, 75);
            background-color: #f0f4f8;
            cursor: default;
        }

        .cell.selected {
            background-color: #a0aec0;
        }

        .cell.highlighted {
            background-color: #edf2f7;
        }
        
        .cell.row-highlight, .cell.col-highlight, .cell.square-highlight {
            background-color: #e2e8f0;
        }
        
        .cell.wrong-number {
            color: #c53030;
        }

        /* Notes styling */
        .notes-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            width: 80%;
            height: 80%;
            font-size: clamp(0.3rem, 1.5vw, 0.6rem);
            color: #718096;
            line-height: 1;
        }
        .note {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Thicker borders for 3x3 squares */
        .cell:nth-child(3n) { border-right: 2px solid #2d3748; }
        .cell:nth-child(3n+1) { border-left: 2px solid #2d3748; }
        .cell:nth-child(27n+1), .cell:nth-child(27n+2), .cell:nth-child(27n+3),
        .cell:nth-child(27n+4), .cell:nth-child(27n+5), .cell:nth-child(27n+6),
        .cell:nth-child(27n+7), .cell:nth-child(27n+8), .cell:nth-child(27n+9) {
            border-top: 2px solid #2d3748;
        }
        .cell:nth-child(n+73):nth-child(-n+81) {
            border-bottom: 2px solid #2d3748;
        }
        .cell:nth-child(9n+1) { border-left: 2px solid #2d3748; }
        .cell:nth-child(9n) { border-right: 2px solid #2d3748; }

        .cell:nth-child(n+1):nth-child(-n+9) { border-top: 2px solid #2d3748; }
        .cell:nth-child(n+73):nth-child(-n+81) { border-bottom: 2px solid #2d3748; }

        /* Controls Panel */
        .controls-panel {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .controls-container {
            margin-top: 1rem;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 0.5rem;
            width: 100%;
        }

        .control-btn {
            background-color: #fff;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: clamp(0.6rem, 2vw, 0.75rem);
            color: #718096;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            flex: 1 1 20%;
        }
        
        .control-btn.active {
            background-color: #e0e7ff; /* Lighter blue for active state */
            border-color: #3b82f6; /* A more prominent border color */
            color: #1e40af; /* Darker blue text */
        }


        /* Number pad styling */
        .number-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 1rem;
            width: 100%;
            max-width: 300px;
        }

        .number-btn {
            background-color: #edf2f7;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(1rem, 4vw, 1.5rem);
            font-weight: 600;
            width: 100%;
            aspect-ratio: 1 / 1;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .message-box.visible {
            display: flex;
        }
        
        @media (min-width: 768px) {
            .main-game-layout {
                flex-direction: row;
                align-items: flex-start;
                justify-content: space-between;
                gap: 4rem;
            }
            .game-panel {
                width: 50%;
                flex-shrink: 0;
            }
            .controls-panel {
                width: 50%;
                padding-top: 1rem;
            }
            .sudoku-grid {
                max-width: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="main-game-layout">
        <div class="game-panel">
            <div class="flex items-center justify-between w-full mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Sudoku</h1>
                <div class="flex items-center space-x-4 text-gray-600">
                    <div id="mistake-counter" class="font-medium text-lg">Mistakes: 0 / 3</div>
                    <div id="timer" class="font-medium text-lg">00:00</div>
                </div>
            </div>
            <div id="sudoku-grid" class="sudoku-grid"></div>
        </div>

        <div class="controls-panel">
            <div class="controls-container">
                <div class="control-btn" id="notes-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-1 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2H3a2 2 0 0 0-2 2v15a2 2 0 0 0 2 2h9z"/><path d="M7 16l4-4 4 4"/><path d="M11 12v6"/></svg>
                    <span>Заметки</span>
                </div>
                <div class="control-btn" id="erase-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-1 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M17 14l-4 4"/></svg>
                    <span>Стереть</span>
                </div>
                <div class="control-btn" id="hint-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-1 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 16c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/><path d="M12 12h.01"/><path d="M12 12a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                    <span>Подсказка</span>
                </div>
            </div>
    
            <div id="number-pad" class="number-pad">
                <div class="number-btn">1</div>
                <div class="number-btn">2</div>
                <div class="number-btn">3</div>
                <div class="number-btn">4</div>
                <div class="number-btn">5</div>
                <div class="number-btn">6</div>
                <div class="number-btn">7</div>
                <div class="number-btn">8</div>
                <div class="number-btn">9</div>
            </div>
    
            <div class="flex justify-center mt-4 w-full">
                <button id="new-game-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-indigo-700 transition duration-200 ease-in-out">Новая игра</button>
            </div>
        </div>
    </div>

    <!-- Message box for game over/win -->
    <div id="message-box" class="message-box">
        <span id="message-text" class="text-4xl font-extrabold text-indigo-700 mb-4"></span>
        <div class="flex flex-col gap-4">
            <div class="text-gray-700 font-semibold text-lg">Choose a new difficulty:</div>
            <div class="difficulty-options flex justify-center gap-4">
                <button id="easy-btn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition duration-200">Easy</button>
                <button id="medium-btn" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition duration-200">Medium</button>
                <button id="hard-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-200">Hard</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gridEl = document.getElementById('sudoku-grid');
            const numberPad = document.getElementById('number-pad');
            const timerEl = document.getElementById('timer');
            const notesBtn = document.getElementById('notes-btn');
            const eraseBtn = document.getElementById('erase-btn');
            const hintBtn = document.getElementById('hint-btn');
            const newGameBtn = document.getElementById('new-game-btn');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const easyBtn = document.getElementById('easy-btn');
            const mediumBtn = document.getElementById('medium-btn');
            const hardBtn = document = document.getElementById('hard-btn');
            const mistakeCounterEl = document.getElementById('mistake-counter');

            let board = [];
            let solution = [];
            let selectedCell = null;
            let notesMode = false;
            let timerInterval = null;
            let seconds = 0;
            let mistakes = 0;
            const mistakeLimit = 3;

            const puzzles = {
                easy: [
                    [5,3,4,6,7,8,9,1,2],
                    [6,7,2,1,9,5,3,4,8],
                    [1,9,8,3,4,2,5,6,7],
                    [8,5,9,7,6,1,3,4,2],
                    [4,2,6,8,5,3,7,9,1],
                    [7,1,3,9,2,4,8,5,6],
                    [9,6,1,5,3,7,2,8,4],
                    [2,8,7,4,1,9,6,3,5],
                    [3,4,5,2,8,6,1,7,9]
                ],
                medium: [
                    [1,5,6,8,2,3,4,9,7],
                    [4,7,9,1,6,5,8,3,2],
                    [3,8,2,7,9,4,1,6,5],
                    [5,6,8,4,3,9,2,7,1],
                    [9,2,3,6,7,1,5,4,8],
                    [7,1,4,5,8,2,6,3,9],
                    [6,4,1,3,5,8,9,2,7],
                    [8,9,7,2,1,6,3,5,4],
                    [2,3,5,9,4,7,8,1,6]
                ],
                hard: [
                    [3,4,8,7,5,2,1,6,9],
                    [2,5,9,1,4,6,8,7,3],
                    [1,6,7,8,9,3,5,2,4],
                    [8,7,5,9,6,1,3,4,2],
                    [4,1,6,2,3,8,7,9,5],
                    [9,2,3,5,7,4,6,1,8],
                    [6,8,4,3,2,9,7,5,1],
                    [5,9,2,4,1,7,4,8,6],
                    [7,3,1,6,8,5,2,9,4]
                ]
            };

            const difficultyGaps = {
                easy: 35,
                medium: 45,
                hard: 55
            };

            // Fisher-Yates shuffle algorithm
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function generatePuzzle(difficulty) {
                // Select a pre-defined full solution
                const solutionArray = puzzles[difficulty];
                solution = JSON.parse(JSON.stringify(solutionArray));
                board = JSON.parse(JSON.stringify(solutionArray));
                
                // Remove numbers to create the puzzle
                let positions = [];
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        positions.push({ r, c });
                    }
                }
                shuffle(positions);

                let cellsToRemove = difficultyGaps[difficulty];
                for (let i = 0; i < cellsToRemove; i++) {
                    const { r, c } = positions[i];
                    board[r][c] = 0;
                }
            }

            function initializeGame(difficulty = 'easy') {
                stopTimer();
                seconds = 0;
                mistakes = 0;
                mistakeCounterEl.textContent = `Mistakes: ${mistakes} / ${mistakeLimit}`;
                startTimer();
                generatePuzzle(difficulty);
                renderGrid();
                messageBox.classList.remove('visible');
                selectedCell = null;
                notesMode = false;
                notesBtn.classList.remove('active');
            }

            function renderGrid() {
                gridEl.innerHTML = '';
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        const cell = document.createElement('div');
                        cell.classList.add('cell');
                        cell.dataset.row = r;
                        cell.dataset.col = c;

                        const value = board[r][c];
                        if (value !== 0) {
                            cell.textContent = value;
                            cell.classList.add('initial');
                        } else {
                            // Empty cell with notes object
                            cell.dataset.notes = JSON.stringify([]);
                        }
                        
                        gridEl.appendChild(cell);
                    }
                }
            }

            function getCell(r, c) {
                return gridEl.querySelector(`[data-row='${r}'][data-col='${c}']`);
            }

            function highlightCells() {
                // Clear all previous highlights
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('selected', 'highlighted', 'row-highlight', 'col-highlight', 'square-highlight');
                });

                if (selectedCell) {
                    const selectedVal = selectedCell.textContent;
                    // Highlight selected cell
                    selectedCell.classList.add('selected');

                    // Highlight all cells with the same value
                    if (selectedVal && !notesMode) {
                        document.querySelectorAll('.cell').forEach(cell => {
                            if (cell.textContent === selectedVal) {
                                cell.classList.add('highlighted');
                            }
                        });
                    }

                    // Highlight selected row and column
                    const selectedRow = parseInt(selectedCell.dataset.row);
                    const selectedCol = parseInt(selectedCell.dataset.col);
                    for (let i = 0; i < 9; i++) {
                        getCell(selectedRow, i).classList.add('row-highlight');
                        getCell(i, selectedCol).classList.add('col-highlight');
                    }

                    // Highlight selected 3x3 square
                    const startRow = Math.floor(selectedRow / 3) * 3;
                    const startCol = Math.floor(selectedCol / 3) * 3;
                    for (let r = startRow; r < startRow + 3; r++) {
                        for (let c = startCol; c < startCol + 3; c++) {
                            getCell(r, c).classList.add('square-highlight');
                        }
                    }
                }
            }

            function updateCellValue(value) {
                if (!selectedCell || selectedCell.classList.contains('initial')) return;

                const r = parseInt(selectedCell.dataset.row);
                const c = parseInt(selectedCell.dataset.col);
                
                // If in notes mode, handle notes
                if (notesMode) {
                    let notes = JSON.parse(selectedCell.dataset.notes);
                    const index = notes.indexOf(value);
                    if (index > -1) {
                        notes.splice(index, 1);
                    } else {
                        notes.push(value);
                    }
                    selectedCell.textContent = ''; // Clear text content for notes
                    selectedCell.dataset.notes = JSON.stringify(notes);
                    renderCellContent(selectedCell);
                } else {
                    // Regular input mode
                    selectedCell.textContent = value;
                    board[r][c] = value;
                    // Check if a new mistake was made
                    if (value !== solution[r][c] && !selectedCell.classList.contains('wrong-number')) {
                        mistakes++;
                        mistakeCounterEl.textContent = `Mistakes: ${mistakes} / ${mistakeLimit}`;
                    }
                }
                updateAllErrors();
                highlightCells();
                checkGameState();
            }

            function renderCellContent(cell) {
                const notes = JSON.parse(cell.dataset.notes);
                cell.innerHTML = ''; // Clear existing content
                if (notes && notes.length > 0) {
                    const notesContainer = document.createElement('div');
                    notesContainer.classList.add('notes-container');
                    
                    for (let i = 1; i <= 9; i++) {
                        const noteDiv = document.createElement('div');
                        noteDiv.classList.add('note');
                        if (notes.includes(i)) {
                            noteDiv.textContent = i;
                        } else {
                            noteDiv.innerHTML = '&nbsp;'; // Use a non-breaking space to keep the grid structure
                        }
                        notesContainer.appendChild(noteDiv);
                    }
                    cell.appendChild(notesContainer);
                }
            }

            function updateAllErrors() {
                // Clear all existing errors
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('error', 'wrong-number');
                });

                // Re-evaluate the entire board for errors
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        const cell = getCell(r, c);
                        const value = board[r][c];

                        if (value === 0) continue;

                        // Check against solution for wrong number
                        if (value !== solution[r][c]) {
                            cell.classList.add('wrong-number');
                        }

                        // Check for duplicates in row
                        for (let i = 0; i < 9; i++) {
                            if (i !== c && board[r][i] === value) {
                                cell.classList.add('error');
                            }
                        }
                        
                        // Check for duplicates in column
                        for (let i = 0; i < 9; i++) {
                            if (i !== r && board[i][c] === value) {
                                cell.classList.add('error');
                            }
                        }

                        // Check for duplicates in 3x3 square
                        const startRow = Math.floor(r / 3) * 3;
                        const startCol = Math.floor(c / 3) * 3;
                        for (let subR = 0; subR < 3; subR++) {
                            for (let subC = 0; subC < 3; subC++) {
                                const curR = startRow + subR;
                                const curC = startCol + subC;
                                if (curR !== r || curC !== c) {
                                    if (board[curR][curC] === value) {
                                        cell.classList.add('error');
                                    }
                                }
                            }
                        }
                    }
                }
            }


            function checkGameState() {
                // Check for loss condition first
                if (mistakes >= mistakeLimit) {
                    stopTimer();
                    messageText.textContent = 'Игра окончена!';
                    messageBox.classList.add('visible');
                    return;
                }

                // Then check for win condition
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (board[r][c] === 0 || board[r][c] !== solution[r][c]) {
                            return; // Not solved yet
                        }
                    }
                }
                stopTimer();
                messageText.textContent = 'Вы выиграли!';
                messageBox.classList.add('visible');
            }

            // Timer functions
            function startTimer() {
                timerInterval = setInterval(() => {
                    seconds++;
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
                    const formattedSeconds = remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds;
                    timerEl.textContent = `${formattedMinutes}:${formattedSeconds}`;
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
            }
            
            // Event Listeners
            gridEl.addEventListener('click', (e) => {
                const cell = e.target.closest('.cell');
                if (cell) {
                    if (selectedCell) {
                        selectedCell.classList.remove('selected');
                    }
                    selectedCell = cell;
                    highlightCells();
                }
            });

            numberPad.addEventListener('click', (e) => {
                const btn = e.target.closest('.number-btn');
                if (btn) {
                    const value = parseInt(btn.textContent);
                    updateCellValue(value);
                }
            });

            notesBtn.addEventListener('click', () => {
                notesMode = !notesMode;
                notesBtn.classList.toggle('active', notesMode);
            });

            eraseBtn.addEventListener('click', () => {
                if (selectedCell && !selectedCell.classList.contains('initial')) {
                    selectedCell.textContent = '';
                    const r = parseInt(selectedCell.dataset.row);
                    const c = parseInt(selectedCell.dataset.col);
                    board[r][c] = 0;
                    selectedCell.dataset.notes = JSON.stringify([]);
                    selectedCell.innerHTML = '';
                    updateAllErrors(); // Update errors after erasing
                    highlightCells();
                }
            });

            hintBtn.addEventListener('click', () => {
                if (selectedCell && !selectedCell.classList.contains('initial') && selectedCell.textContent === '') {
                    const r = parseInt(selectedCell.dataset.row);
                    const c = parseInt(selectedCell.dataset.col);
                    selectedCell.textContent = solution[r][c];
                    board[r][c] = solution[r][c];
                    updateAllErrors(); // Update errors after getting a hint
                    checkGameState();
                }
            });

            newGameBtn.addEventListener('click', () => {
                messageBox.classList.add('visible');
            });
            
            easyBtn.addEventListener('click', () => initializeGame('easy'));
            mediumBtn.addEventListener('click', () => initializeGame('medium'));
            hardBtn.addEventListener('click', () => initializeGame('hard'));

            // Keyboard input
            document.addEventListener('keydown', (e) => {
                if (e.key >= '1' && e.key <= '9') {
                    updateCellValue(parseInt(e.key));
                } else if (e.key === 'Backspace' || e.key === 'Delete') {
                    if (selectedCell && !selectedCell.classList.contains('initial')) {
                        selectedCell.textContent = '';
                        const r = parseInt(selectedCell.dataset.row);
                        const c = parseInt(selectedCell.dataset.col);
                        board[r][c] = 0;
                        selectedCell.dataset.notes = JSON.stringify([]);
                        selectedCell.innerHTML = '';
                        updateAllErrors(); // Update errors after erasing
                        highlightCells();
                    }
                }
            });

            // Initial game start
            initializeGame();
        });
    </script>

</body>
</html>
